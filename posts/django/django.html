<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../../icons/logoTit.png">
    <link rel="stylesheet" href="../../estilo.css">
    <title>UB Social</title>
</head>
<body>
<div class="container-fluid">


    <div class="row">
        <div class="col-sm-12">
            <nav class="navbar rounded-bottom fixed-top navbar-expand-lg navbar-light bg-light shadow">
                <div class="container-fluid">
                    <a class="navbar-brand" href="../../index.html"><img src="../../icons/logo.png" class="d-inline-block align-text-top" width="11pt"> UB Social</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="../../index.html">Home</a></li>
                            <li class="nav-item"><a class="nav-link" href="../../sobre/sobre.html">Sobre</a></li>
                            <li class="nav-item"><a class="nav-link" href="../../cursos.html">Cursos</a></li>
                            <li class="nav-item"><a class="nav-link" href="../../livros/livros.html">Livros</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12 text-center" id="titulo">
            <h1>Django</h1>
            <h6><strong>Estrutura e sintaxe Django</strong><br><br><span class="badge bg-warning text-dark">Resumo em construção</span></h6>
            <a href="../../index.html" class="btn btn-link text-decoration-none mb-3">Voltar</a>
        </div>

        <div class="col-sm-12">
            <h4>Material complementar:</h4>
            <ul>
                <li>Conteúdo no YouTube: <a href="https://youtube.com/playlist?list=PLnPZ9TE1Tj4BMN4I4Dce6HZ8pXiw99-gq&si=KSiS0GZeTQYaC1CV" target="_blank" class="text-decoration-none">Acesse</a></li>
                <li>Conteúdo no GitHub: <a href="https://github.com/mateusschwede/Django" target="_blank" class="text-decoration-none">Acesse</a></li>
                <li>Curso gratuito com certificado na Workover Academy (Curso de Django API REST): <a href="https://workover.com.br/cursos/1850/curso-de-django-api-rest" target="_blank" class="text-decoration-none">Acesse</a></li>
            </ul>

            <br><h4>Introdução</h4>
            <ol>
                <b><u>Instalar Django</u>:</b>
                <li><b>Pré-requisito (pip):</b> sudo apt install python3-pip</li>
                <li><b>Instalar ecossistema Django:</b> pip3 install django djangorestframework markdown django-filter django-cors-headers --break-system-packages
                <br><b><u>Criar usuário Django admin</u> (opcional):</b>
                <li><b>Cadastrar usuário no dashboard Django admin:</b> python3 manage.py createsuperuser <span class="text-muted">#Informar dados do usuário</span></li>
                <li><b>Acessar dashboard Django admin:</b> <a href="http://localhost:8000/admin" class="text-decoration-none" target="_blank">localhost:8000/admin</a></li>
                <br><b><u>Iniciar projeto Django</u>:</b>
                <li><b>Criar pasta do projeto:</b> django-admin startproject nomePastaProjeto</li>
                <li><b>Na pasta do projeto, criar aplicação:</b> python3 manage.py startapp nomeApp</li>
                <li><b>Em 'pastaApp/settings.py':</b> Inserir o nome da App, conforme criado acima, como último elemento do array em INSTALLED_APPS</li>
                <li>Realizar a programação, com seu código</li>
                <li><b>Criar migrations:</b> python3 manage.py makemigrations</li>
                <li><b>Executar migrations:</b> python3 manage.py migrate</li>
                <li><b>Executar projeto:</b> python3 manage.py runserver <span class="text-muted">#Acesso padrão em <a href="http://localhost:8000" class="text-decoration-none" target="_blank">localhost:8000</a></span></li>
            </ol>

            <br><h4>Estrutura</h4>
            <img src="estrutura.png" class="img-fluid rounded" width="230px"><br><br>
            <ul>
                <li>pastaProjeto/
                    <ul>
                        <li>pastaAplicacao/
                            <ul>
                                <li>migrations/ <span class="text-muted">#Pasta com arquivos de interação com BD</span></li>
                                <li>admin.py <span class="text-muted">#Configurações da interface administrativa (Registramento de usuários e Objetos para dashboard Django admin)</span></li>
                                <li>apps.py <span class="text-muted">#Registramento da aplicação ao projeto</span></li>
                                <li>models.py <span class="text-muted">#Models da aplicação (Classes de persistência)</span></li>
                                <li>tests.py <span class="text-muted">#Testes automatizados da aplicação e regras sobre (Testes unitários, testes de regressão, testes de integração, etc). Pode-se criar diretórios 'tests/' para inserir mais arquivos dentro (Executar arquivos tests.py: 'python3 manage.py test' ou 'python3 manage.py test proj.pasta.arq')</span></li>
                                <li>views.py <span class="text-muted">#Views da aplicação (Funções de tratamento de requisições, responsáveis por renderização do projeto)</span></li>
                                <li>(Criado manualmente) templates/ <span class="text-muted">#Pasta com arquivos Html para frontend do projeto</span></li>
                                <li>(Criado manualmente) forms.py <span class="text-muted">#Registramento de formulários de geração automática pelo Django</span></li>
                                <li>(Criado manualmente) urls.py <span class="text-muted">#Arquivo secundário de rotas da aplicação</span></li>
                            </ul>
                        </li>
                        <li>subPastaProjeto/
                            <ul>
                                <li>pychache/ <span class="text-muted">#Pasta com arquivos de cache</span></li>
                                <li>__init.py__ <span class="text-muted">#Módulo para marcar App como package do projeto</span></li>
                                <li>asgi.py <span class="text-muted">#Integração entre servidores web compatíveis com ASGI e a App</span></li>
                                <li>settings.py <span class="text-muted">#Configurações gerais do projeto (Configuração de host, BD, nome da App, etc)</span></li>
                                <li>urls.py <span class="text-muted">#Rotas da aplicação, arquivo geral (Mapeamento de url relacionada com sua determinada Model)</span></li>
                                <li>wsgi.py <span class="text-muted">#Integração entre servidores web WSGI e a App</span></li>
                            </ul>
                        </li>
                        <li>manage.py <span class="text-muted">#Responsável para execução dos comandos do framework</span></li>
                    </ul>
                </li>
            </ul>

            <br><h4>Funcionamento</h4>
            <img src="funcionamento.jpg" class="img-fluid" width="400px"><br>
            <img src="http_funcionamento.png" class="img-fluid" width="400px"><br>

            <br><h4>settings.py:</h4>
            <p id="textoPost">Arquivo de configurações gerais do projeto.</p>
<small><pre><code>
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent
SECRET_KEY = 'CHAVES' # Não seguro. Ideal informar a chave em variáveis de ambiente (arquivo .env) e referenciar aqui usando os.environ.get('SECRET_KEY')

DEBUG = True # True para projeto em desenvolvimento, False para produção
ALLOWED_HOSTS = [] # Lista de IPs ou domínios permitidos para acessar a aplicação

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'nomeAppDoProjeto',
] # Lista de apps instalados no projeto, incluindo apps personalizados e de terceiros

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'corsheaders.middleware.CorsMiddleware',
] # Lista de middlewares usados no projeto, incluindo middlewares de segurança, autenticação e CORS


REST_FRAMEWORK = &#123;
    'DEFAULT_AUTHENTICATION_CLASSES': (
        #'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.TokenAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticatedOrReadOnly',
    ),
    
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 2,
    'DEFAULT_THROTTLE_CLASSES': (
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ),
    'DEFAULT_THROTTLE_RATES': &#123;
        'anon': '2/minute', #second,day,month,year
        'user': '3/minute'
    &#125;,
        'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
    ]
&#125; # Configurações do Django REST Framework para usar JSON como formato de entrada e saída, autenticação por token, permissões de leitura para não autenticados e paginação de resultados


CORS_ALLOW_ALL_ORIGINS = True # Permite que qualquer origem acesse API. Em produção, recomenda-se configurar CORS de forma mais restritiva usando CORS_ALLOWED_ORIGINS

ROOT_URLCONF = 'paris_cafe.urls' # Módulo de URLs raiz do projeto, onde rotas principais são definidas

TEMPLATES = [
    &#123;
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': &#123;
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        &#125;,
    &#125;,
] # Configurações de templates do Django, incluindo diretórios de templates e processadores de contexto

WSGI_APPLICATION = 'paris_cafe.wsgi.application' # Módulo WSGI do projeto, usado para implantação em servidores compatíveis com WSGI

DATABASES = &#123;
    'default': &#123;
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    &#125;
&#125; # Configurações de banco de dados, usando SQLite para desenvolvimento

AUTH_PASSWORD_VALIDATORS = [
    &#123;
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    &#125;,
    &#123;
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    &#125;,
    &#123;
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    &#125;,
    &#123;
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    &#125;,
] # Configurações de validação de senha para garantir senhas seguras

# Configurações de internacionalização e fuso horário:
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

STATIC_URL = 'static/' # URL para servir arquivos estáticos (CSS, JavaScript, imagens)

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField' # Configuração para usar BigAutoField como tipo de campo padrão para chaves primárias em modelos, garantindo IDs únicos e escaláveis

MEDIA_URL = '/media/' # URL para servir arquivos de mídia enviados pelos usuários
MEDIA_ROOT = os.path.join(BASE_DIR, 'media') # Diretório onde arquivos de mídia serão armazenados no sistema de arquivos do servidor

LOGIN_URL = '/login' # URL para página de login, onde usuários não autenticados serão redirecionados ao tentar acessar áreas protegidas do site
LOGIN_REDIRECT_URL = '/'
LOGOUT_URL = '/logout'
LOGOUT_REDIRECT_URL = '/login'

AUTHENTICATION_BACKENDS = [
    'social_core.backends.google.GoogleOAuth2',
    'social_core.backends.facebook.FacebookOAuth2',
    'django.contrib.auth.backends.ModelBackend',
]

SOCIAL_AUTH_FACEBOOK_EXTRA_DATA = [
    ('name', 'name'),
    ('email', 'email'),
    ('picture', 'picture'),
    ('link', 'profile_url'),
]

import django_heroku
django_heroku.settings(locals())
</code></pre></small>

            <br><h4>models.py:</h4>
            <p id="textoPost">Arquivo contendo Models da aplicação. Pode estar localizado em diretório chamado, models dentra da pasta da app, onde cada Model é arquivo cujo nome é mesmo da respectiva classe. Models são classes de persistência, responsável por representar tabela do banco de dados e seus campos. Cada atributo da classe representa campo da tabela (com suas características e condições), onde Django se encarrega de criar estrutura do banco de dados com base nessas definições. Models também podem incluir métodos para manipulação dos dados, como validação, formatação ou cálculos relacionados aos campos definidos. Exemplo de model (models/activity.py):</p>
<small><pre><code>
from django.db import models

class Activity(models.Model):
    strava_id = models.BigIntegerField(
        unique=True,
        help_text="ID da atividade no Strava",
    )
    name = models.CharField(
        max_length=255,
        help_text="Nome da atividade",
    )
    distance = models.FloatField(
        help_text="Distância em metros",
    )
    moving_time = models.PositiveIntegerField(
        help_text="Tempo em movimento (segundos)",
    )
    sport_type = models.CharField(
        max_length=50,
        help_text="Tipo de esporte (Run, Walk, Ride, etc)",
    )
    start_date = models.DateTimeField(
        help_text="Data/hora de início (UTC)",
    )
    average_speed = models.FloatField(
        null=True,
        blank=True,
        help_text="Velocidade média (m/s)",
    )

    created_at = models.DateTimeField(
        auto_now_add=True,
    )

    class Meta:
        ordering = ["-start_date"]
        verbose_name = "Atividade"
        verbose_name_plural = "Atividades"

    def __str__(self) -&gt; str:
        return f"&#123;self.name&#125; - &#123;self.distance / 1000:.2f&#125; km"
</code></pre></small>

            <br><p>Exemplo de Model com métodos (models/Profile.py):</p>
<small><pre><code>
from medicSearch.models import *
from django.db.models import Sum, Count

class Profile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    role = models.IntegerField(choices=ROLE_CHOICE, default=3)
    birthday = models.DateField(default=None, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    token = models.CharField(max_length=255, null=True, blank=True)
    image = models.ImageField(null=True, blank=True)
    favorites = models.ManyToManyField(User, blank=True, related_name='favorites')
    specialties = models.ManyToManyField(Speciality, blank=True, related_name='specialties')
    addresses = models.ManyToManyField(Address, blank=True, related_name='addresses')
    
    def __str__(self):
        return '&#123;&#125;'.format(self.user.username)

    @receiver(post_save, sender=User)
    def create_user_profile(sender, instance, created, **kwargs):
        try:
            if created:
                Profile.objects.create(user=instance)
        except:
            pass

    @receiver(post_save, sender=User)
    def save_user_profile(sender, instance, **kwargs):
        try:
            instance.profile.save()
        except:
            pass

    def show_scoring_average(self):
        from .Rating import Rating
        try:
            ratings = Rating.objects.filter(user_rated=self.user).aggregate(Sum('value'), Count('user'))
            if ratings['user__count'] &gt; 0:
                scoring_average = ratings['value__sum'] / ratings['user__count']
                scoring_average = round(scoring_average, 2) # Arredondando o valor para duas casas decimais
                return scoring_average
            return 'Sem avaliações'
        except:
            return 'Sem avaliações'

    def show_favorites(self):
        ids = [result.id for result in self.favorites.all()]
        return Profile.objects.filter(user__id__in=ids)

    def show_ratings(self):
        from .Rating import Rating
        return Rating.objects.filter(user_rated=self.user)
</code></pre></small>

            <br><p id="textoPost">Exemplo de Model com Meta (models/Profile.py):</p>
<small><pre><code>
from django.db import models

class Base(models.Model):
    criacao = models.DateTimeField(auto_now_add=True)
    atualizacao = models.DateTimeField(auto_now=True)
    ativo = models.BooleanField(default=True)
    
    class Meta:
        abstract = True

class Curso(Base):
    titulo = models.CharField(max_length=255)
    url = models.URLField(unique=True)

    class Meta:
        verbose_name = 'Curso'
        verbose_name_plural = 'Cursos'
        ordering = ['id']
        #Decrescente: ordering = ['-id']
    
    def __str__(self):
        return self.titulo

class Avaliacao(Base):
    curso = models.ForeignKey(Curso, related_name='avaliacoes', on_delete=models.CASCADE)
    nome = models.CharField(max_length=255)
    email = models.EmailField()
    comentario = models.TextField(blank=True, default='')
    avaliacao = models.DecimalField(max_digits=2, decimal_places=1)

    class Meta:
        verbose_name = 'Avaliação'
        verbose_name_plural = 'Avaliações'
        unique_together = ['email', 'curso']
        ordering = ['id']
    
    def __str__(self):
        return f'&#123;self.nome&#125; avaliou o curso &#123;self.curso&#125; com nota &#123;self.avaliacao&#125;'
</code></pre></small>

            <br><p>Opcionalmente, alguns projetos possui models na pasta de models, onde há arquivo de inicialização e regras de negócio (__init__.py):</p>
<small><pre><code>
from django.db import models
from django.contrib.auth.models import User
from django.db.models.signals import post_save
from django.dispatch import receiver

ROLE_CHOICE = (
    (1, 'Admin'),
    (2, 'Médico'),
    (3, 'Paciente')
)

# Outras models desse projeto específico:
from .Rating import Rating
from .DayWeek import DayWeek
from .State import State
from .City import City
from .Neighborhood import Neighborhood
from .Address import Address
from .Speciality import Speciality
from .Profile import Profile
</code></pre></small>

            <br><h4>Rotas globais:</h4>
            <p id="textoPost">Arquivo de rotas globais do projeto, onde são mapeadas URLs para respectivas views, acessíveis a todo projeto. Geralmente localizado em pastaProjeto/urls.py. Exemplo:</p>
<small><pre><code>
from django.contrib import admin
from django.urls import path
from django.conf.urls.static import static
from django.conf import settings
from django.conf.urls import url, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('medicSearch.urls.HomeUrls')),
    path('', include('medicSearch.urls.AuthUrls')),
    path('profile/', include('medicSearch.urls.ProfileUrls')),
    path('medic/', include('medicSearch.urls.MedicUrls')),
] + static(settings.STATIC_URL, document_root=settings.STATIC_ROOT) + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</code></pre></small>

            <br><p id="textoPost">Exemplo simples (pastaProjeto/urls.py):</p>
<small><pre><code>
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('cafes.urls')), # Arquivo de rotas locais, da app 'cafes'
]
</code></pre></small>

            <br><p id="textoPost">Exemplo, usando versionamento de APIs REST (pastaProjeto/urls.py):</p>
<small><pre><code>
from django.contrib import admin
from django.urls import path, include
from cursos.urls import router

urlpatterns = [
    path('api/v1/', include('cursos.urls')),
    path('api/v2/', include(router.urls)),
    path('admin/', admin.site.urls),
    path('auth/', include('rest_framework.urls')),
]
</code></pre></small>

            <br><p id="textoPost">Exemplo, usando ViewSets (pastaProjeto/urls.py):</p>
<small><pre><code>
from django.urls import path
from .views import BookListCreateView, BookRetrieveUpdateDestroyView

urlpatterns = [
    path('books/', BookListCreateView.as_view(), name='book-list-create'),
    path('books/&lt;int:pk&gt;/', BookRetrieveUpdateDestroyView.as_view(), name='book-detail'),
]
</code></pre></small>

            <br><p id="textoPost">Exemplo, usando JWT (pastaProjeto/urls.py):</p>
<small><pre><code>
from django.contrib import admin
from django.urls import path, include
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)

urlpatterns = [
    path("admin/", admin.site.urls),
    path("api/auth/token/", TokenObtainPairView.as_view(), name="token_obtain_pair"),
    path("api/auth/token/refresh/", TokenRefreshView.as_view(), name="token_refresh"),
    path("api/", include("apps.activities.urls")),
]
</code></pre></small>

            <br><h4>Rotas locais:</h4>
            <p>Em breve...</p>
        </div>
    </div>


<!--Rodapé-->
<div class="row">
    <div class="col-sm-12 text-center bg-black text-light pt-4 pb-3">
        <p>Elaborado por Mateus Schwede<br><small class="text-muted">ubsocial.github.io</small></p>
    </div>
</div>

</div>
</body>
</html>